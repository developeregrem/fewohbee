<!-- Nav tabs -->
<ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link{% if tab is defined and tab == 'booker' %} active{% endif %}" href="#reservation" data-bs-toggle="tab">{{ 'reservation.details'|trans }}</a>
    </li>
    <li class="nav-item">
        <a class="nav-link{% if tab is defined and tab == 'guest' %} active{% endif %}" href="#guests" data-bs-toggle="tab">{{ 'reservation.preview.customer.inroom'|trans }}</a>
    </li>
    <li class="nav-item">
        {% if booker is defined and booker is not null %}
            <a class="nav-link{% if tab is defined and tab == 'correspondence' %} active{% endif %}" href="#correspondence" data-bs-toggle="tab">{{ 'reservation.correspondences'|trans }}</a>
        {% else %}
            <span class="nav-link disabled text-muted" aria-disabled="true">{{ 'reservation.correspondences'|trans }}</span>
        {% endif %}
    </li>
    <li class="nav-item">
        <a class="nav-link{% if tab is defined and tab == 'prices' %} active{% endif %}" href="#prices" data-bs-toggle="tab">{{ 'reservation.prices.title'|trans }}</a>
    </li>
</ul>

<!-- Tab panes -->
<div class="tab-content p-4">
    <div class="tab-pane{% if tab is defined and tab == 'booker' %} active{% endif %}" id="reservation" role="tabpanel" aria-labelledby="booker-tab">
        <div class="row">
            <div class="col">                    
                <h4 class="border-bottom pb-2">{{ 'reservation.preview.booker'|trans }}
                    {% if mode is defined and mode == 'edit' %}
                        {% if booker is defined and booker is not null %}
                            <form id="actions-booker-{{ booker.id }}" class="d-none">
                                <input id="reservation-id" type="hidden" value="{{ reservationId }}"
                                       name="reservation-id"/>
                                <input id="customer-id" type="hidden" value="{{ booker.id }}"
                                       name="customer-id"/>
                                <input id="tab" type="hidden" value="booker" name="tab"/>
                                <input name="_csrf_token" value="{{ token }}" type="hidden">
                            </form>
                        {% endif %}
                        {% if is_granted('ROLE_RESERVATIONS') %}
                        <small>
                            {% if booker is defined and booker is not null %}
                                <a href="#"
                                   data-action="click->reservations#editReservationCustomerEditAction"
                                   data-customer-id="{{ booker.id }}"
                                   data-form-selector="#actions-booker-{{ booker.id }}"
                                   data-url="{{ path('reservations.edit.customer.edit') }}"
                                   title="{{ 'button.edit'|trans }}" class="float-end text-secondary">
                                    <i class="fas fa-edit"></i>
                                </a>
                            {% endif %}
                            <a href="#"
                               data-action="click->reservations#changeReservationCustomerAction"
                               data-url="{{ path('reservations.edit.reservation.customer', {'id': reservationId}) }}"
                               data-reservation-id="{{ reservationId }}"
                               data-tab="booker"
                               data-appartment-id="0"
                               title="{{ 'reservation.button.changeBooker'|trans }}" class="float-end text-secondary">
                                <i class="fas fa-exchange-alt" style="margin-right: 5px;"></i>
                            </a>
                        </small>
                        {% endif %}
                    {% endif %}
                </h4>
            </div>          
        </div>
        <div class="row p-2">
            {% if booker is defined and booker is not null %}
                {% include 'Customers/_show_info.html.twig' with {'customer' : booker} %}
            {% else %}
                <div class="col-12 text-muted">
                    {{ 'reservation.import.booker.missing'|trans }}
                </div>
            {% endif %}
        </div>                        
            {% if booker is defined and booker is not null %}
                {% include 'Customers/customer_show_address_fields_short.html.twig' with {'customer' : booker} %}
            {% endif %}

        <h4 class="mt-4 pb-2">{{ 'reservation.preview.appartments.selected'|trans }}
            {% if mode is defined and mode == 'edit' %}
            {% if is_granted('ROLE_RESERVATIONS') %}
            <small>
                <a href="#"
                   data-action="click->reservations#editReservationAction"
                   data-url="{{ path('reservations.edit.reservation', {'id': reservationId}) }}"
                   data-reservation-id="{{ reservationId }}"
                   title="{{ 'button.edit'|trans }}" class="float-end text-secondary">
                    <i class="fas fa-edit"></i>
                </a>
            </small>
            {% endif %}
            {% endif %}
        </h4>

        <table class="table">
            <tr>
                <th>{{ 'appartment.number'|trans }}</th>
                <th>{{ 'appartment.description'|trans }}</th>
                <th>{{ 'reservation.persons'|trans }}</th>
                <th>{{ 'reservation.status'|trans }}</th>
                <th>{{ 'reservation.startdate'|trans }}</th>
                <th>{{ 'reservation.enddate'|trans }}</th>
            </tr>
            {% for reservation in reservations %}
                <tr>
                    <td>{{ reservation.appartment.number }}</td>
                    <td>{{ reservation.appartment.description }}</td>
                    <td>{{ reservation.persons }}</td>
                    <td>{{ reservation.reservationStatus.name }}</td>
                    <td>{{ reservation.startdate|date('d.m.Y') }}</td>
                    <td>{{ reservation.enddate|date('d.m.Y') }}</td>
                </tr>
            {% endfor %}
        </table>
        <div class="row mt-4">
            <div class="col-sm-6">
                <label for="reservation-arrivalTime">{{ 'reservation.arrivalTime'|trans }}</label>
                {% if mode is defined and mode == 'edit' and is_granted('ROLE_RESERVATIONS') %}
                <a href="#"
                   data-action="click->reservations#openModalContentAction"
                   data-url="{{ path('reservations.edit.remark', {'id': reservationId}) }}"
                   data-title="{{ 'nav.reservation.edit'|trans }}"
                   title="{{ 'button.edit'|trans }}" class="float-end text-secondary">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
                <div class="mt-2">
                {% if mode is defined and mode == 'edit' %}
                    <span>
                        {% if attribute(reservations, 0).arrivalTime %}
                            {{ attribute(reservations, 0).arrivalTime|date('H:i') }}
                        {% else %}
                            &ndash;
                        {% endif %}
                    </span>
                {% else %}
                    <input type="time" id="reservation-arrivalTime" name="arrivalTime" class="form-control"
                           value="{% if attribute(reservations, 0).arrivalTime %}{{ attribute(reservations, 0).arrivalTime|date('H:i') }}{% endif %}">
                {% endif %}
                </div>
            </div>
            <div class="col-sm-6">
                <label for="reservation-departureTime">{{ 'reservation.departureTime'|trans }}</label>
                {% if mode is defined and mode == 'edit' and is_granted('ROLE_RESERVATIONS') %}
                <a href="#"
                   data-action="click->reservations#openModalContentAction"
                   data-url="{{ path('reservations.edit.remark', {'id': reservationId}) }}"
                   data-title="{{ 'nav.reservation.edit'|trans }}"
                   title="{{ 'button.edit'|trans }}" class="float-end text-secondary">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
                <div class="mt-2">
                {% if mode is defined and mode == 'edit' %}
                    <span>
                        {% if attribute(reservations, 0).departureTime %}
                            {{ attribute(reservations, 0).departureTime|date('H:i') }}
                        {% else %}
                            &ndash;
                        {% endif %}
                    </span>
                {% else %}
                    <input type="time" id="reservation-departureTime" name="departureTime" class="form-control"
                           value="{% if attribute(reservations, 0).departureTime %}{{ attribute(reservations, 0).departureTime|date('H:i') }}{% endif %}">
                {% endif %}
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-sm-3">
                <label for="reservation-remark">{{ 'customer.remark'|trans }}</label>
                {% if mode is defined and mode == 'edit' and is_granted('ROLE_RESERVATIONS') %}
                <a href="#"
                   data-action="click->reservations#openModalContentAction"
                   data-url="{{ path('reservations.edit.remark', {'id': reservationId}) }}"
                   data-title="{{ 'nav.reservation.edit'|trans }}"
                   title="{{ 'button.edit'|trans }}" class="float-end text-secondary">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
            </div>
            <div class="col-sm-9">
                {% if mode is defined and mode == 'edit' %}
                    <span>{{ attribute(reservations, 0).remark|nl2br }}</span>
                {% else %}
                 <textarea id="reservation-remark" class="form-control"name="remark">{{ attribute(reservations, 0).remark }}</textarea>
                {% endif %}                   
            </div>
        </div>
            
        <div class="row mt-4">
            <div class="col-sm-3">
                <label for="reservation-origin">{{ 'reservation.origin'|trans }}</label>
                {% if mode is defined and mode == 'edit' and is_granted('ROLE_RESERVATIONS') %}
                <a href="#"
                   data-action="click->reservations#openModalContentAction"
                   data-url="{{ path('reservations.edit.remark', {'id': reservationId}) }}"
                   data-title="{{ 'nav.reservation.edit'|trans }}"
                   title="{{ 'button.edit'|trans }}" class="float-end text-secondary">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
            </div>
            <div class="col-sm-9">
                {% if mode is defined and mode == 'edit' %}
                    <span>{{ attribute(reservations, 0).reservationOrigin.name }}</span>
                    {% if attribute(reservations, 0).calendarSyncImport is defined and attribute(reservations, 0).calendarSyncImport is not null %}
                        <span class="ms-1">(<i class="fas fa-cloud-download-alt"></i> {{ attribute(reservations, 0).calendarSyncImport.name }})</span>
                    {% endif %}
                {% else %}
                <select id="reservation-origin" name="reservation-origin" class="form-select">
                    {% for origin in origins %}
                        <option value="{{ origin.id }}" {% if attribute(reservations, 0).reservationOrigin and origin.id == attribute(reservations, 0).reservationOrigin.id  %} selected {% endif %}>
                            {{ origin.name }}
                        </option>
                    {% endfor %}
                </select>
                {% endif %}
                
            </div>
        </div>
        <input id="_csrf_token" name="_csrf_token" value="{{ token }}" type="hidden">

        

    </div>
    <div class="tab-pane{% if tab is defined and tab == 'guest' %} active{% endif %}" id="guests" role="tabpanel" aria-labelledby="guests-tab">
        {% for reservation in reservations %}
        <div class="row">
            <div class="col">            
                <h4 class="pb-2">{{ 'reservation.preview.customer'|trans }} {{ 'reservation.appartment.name'|trans }}: {{ reservation.appartment.number }}
                    {% if is_granted('ROLE_RESERVATIONS') %}
                    <small>
                    <a href="#"
                       data-action="click->reservations#changeReservationCustomerAction"
                       data-url="{{ path('reservations.edit.reservation.customer', {'id': reservationId}) }}"
                       data-reservation-id="{{ reservationId }}"
                       data-tab="guest"
                       data-appartment-id="{{ reservation.appartment.id }}"
                       title="{{ 'button.add'|trans }}" class="float-end text-secondary">
                        <i class="fas fa-plus"></i></a>
                    </small>
                    {% endif %}
                </h4>
            </div> 
        </div>                           
        <table class="table table-hover">
            <thead>
            <tr>
                <th>{{ 'reservation.preview.customer.name'|trans }}</th>                            
                <th>{{ 'customer.birthday'|trans }}</th>
                <th>{{ 'customer.action'|trans }}</th>
            </tr>
            </thead>
            <tbody>
            {% for customer in customers %}
                {% if mode is defined and mode == 'new' %}                                
                    {% if customer.appartmentId == reservation.appartment.id %}
                        {% set customer = customer.c %}
                    {% endif %}
                {% endif %}
                {% if customer.salutation is defined %}
                <tr>
                    <td>{{ customer.salutation }} {{ customer.firstname }} {{ customer.lastname }}</td>                            
                    <td>{% if customer.birthday %}{{ customer.birthday|date('d.m.Y') }}{% endif %}</td>
                    <td>
                        <form id="actions-customer-{{ customer.id }}">
                            <input id="reservation-id" type="hidden" value="{{ reservationId }}"
                                   name="reservation-id"/>
                            <input id="customer-id" type="hidden" value="{{ customer.id }}"
                                   name="customer-id"/>
                            <input id="tab" type="hidden" value="guest" name="tab"/>
                            <input id="appartmentId" type="hidden" value="{{ reservation.appartment.id }}" name="appartmentId"/>
                            <input name="_csrf_token" value="{{ token }}" type="hidden">
                        </form>
                        {% if is_granted('ROLE_RESERVATIONS') %}
                        <a href="#"
                           data-action="click->reservations#editReservationCustomerEditAction"
                           data-customer-id="{{ customer.id }}"
                           data-form-selector="#actions-customer-{{ customer.id }}"
                           data-url="{{ path('reservations.edit.customer.edit') }}"
                           title="{{ 'button.edit'|trans }}">
                            <i class="fas fa-edit"></i></a>
                        <a href="#"
                           data-action="click->reservations#deleteReservationCustomerAction"
                           data-customer-id="{{ customer.id }}"
                           data-url="{{ path('reservations.edit.delete.customer') }}"
                           title="{{ 'button.delete'|trans }}">
                            <i class="fas fa-trash-alt"></i></a>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
        {% endfor %}        
    </div>
    
    <div class="tab-pane{% if tab is defined and tab == 'correspondence' %} active{% endif %}" id="correspondence" role="tabpanel" aria-labelledby="correspondence-tab">
        <div class="row">
            <div class="col">
                <h4 class="pb-2">{{ 'reservation.correspondences.reservation'|trans }}
                    {% if mode is defined and mode == 'edit' and is_granted('ROLE_RESERVATIONS') %}
                        <small>
                            <a href="#" data-action="click->reservations#selectReservationForTemplateAction" 
                                data-url="{{ path('settings.templates.select.reservation') }}" 
                                data-reservation-id="{{ reservationId }}" 
                                data-create-new="true"
                                title="{{ 'button.add'|trans }}" class="float-end text-secondary">
                                <i class="fas fa-plus"></i></a>
                        </small>
                    {% endif %}
                </h4>
            </div>
        </div>
        <table class="table">
            <thead>
            <tr>
                <th></th>
                <th>{{ 'templates.correspondence.created'|trans }}</th>
                <th>{{ 'templates.correspondence.name'|trans }}</th>
                <th></th>
                <th>{{ 'base.action'|trans }}</th>
            </tr>
            </thead>
            <tbody>
            {% for correspondence in correspondences %}
            <tr>
                <td style="width:10.0pt"><i class="fas {{ correspondence.template.templateType.icon }}" aria-hidden="true" title="{{ correspondence.template.templateType.name|trans }}"></i></td>
                <td>{{ correspondence.created|date('d.m.Y H:i') }}</td>
                <td>{{ correspondence.name }}</td>
                <td style="width:10.0pt">{% if correspondence.children|length > 0 %}<i class="fas fa-paperclip"></i>{% endif %}</td>
                <td>
                    {% if 'PDF' in correspondence.template.templateType.name %}
                    <a href="#"
                       data-action="click->reservations#exportPDFCorrespondenceAction"
                       data-url="{{ path('settings.templates.correspondence.export.pdf', {'id': correspondence.id}) }}"
                       data-attachment-id="{{ correspondence.id }}"
                       title="{{ 'button.download'|trans }}"><i class="fas fa-download"></i></a>
                    {% elseif 'EMAIL' in correspondence.template.templateType.name %}
                    <a href="#"
                       data-action="click->reservations#showMailCorrespondenceAction"
                       data-url="{{ path('settings.templates.correspondence.show', {'id': correspondence.id}) }}"
                       data-reservation-id="{{ reservationId }}"
                       data-correspondence-id="{{ correspondence.id }}"
                       title="{{ 'button.details'|trans }}"><i class="fas fa-eye"></i></a>
                    {% endif %}
                    {% if is_granted('ROLE_RESERVATIONS') %}
                    <a href="#"
                       data-action="click->reservations#deleteCorrespondenceAction"
                       data-url="{{ path('settings.templates.correspondence.remove') }}"
                       data-correspondence-id="{{ correspondence.id }}"
                       data-reservation-id="{{ reservationId }}"
                       title="{{ 'button.delete'|trans }}"><i class="fas fa-trash-alt"></i></a>  
                    {% endif %}                                  
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>                    
        <input id="_csrf_token" name="_csrf_token" value="{{ token }}" type="hidden">
    </div>
    
    <div class="tab-pane{% if tab is defined and tab == 'prices' %} active{% endif %}" id="prices" role="tabpanel" aria-labelledby="prices-tab">
        <div class="row">
            <div class="col">
                <h4 class="pb-2">{{ 'reservation.prices.misc'|trans }}</h4>
            </div>
        </div>    
        <div id="reservation-price-misc-options" class="row justify-content-start">    
        {% set reservationPrices =  attribute(reservations, 0).prices %}
        {% for price in miscPrices %}
            <div class="col-md-4">
                <form id="update-misc-price-{{ price.id }}" action="{{ path('reservations.update.misc.price', {'reservationId': reservationId, 'id': price.id}) }}">                                   
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="customCheck{{ loop.index }}" data-id="{{ price.id }}" 
                               data-reservation-id="{{ reservationId }}" {% if existsById(reservationPrices, price) %} checked{% endif %}>
                        <label class="form-check-label" for="customCheck{{ loop.index }}">{{ price.description }}</label>
                    </div>                
                    <input type="hidden" name="_token" value="{{ csrf_token('reservation-update-misc-price') }}"/>
                </form>
            </div>
        {% endfor %}            
        </div>
        <input id="_csrf_token" name="_csrf_token" value="{{ token }}" type="hidden">        
        
        <div class="row mt-4">
            <div class="col fs-5 fw-bold ">{{ 'invoice.price.total'|trans }}: {{ brutto|number_format(2, ',', '.') }}</div>
        </div>
        {# variable that contains the status whether prices are used that includes vat and does not include vats
        this will lead to price sums that are displayed incorrect #}
        {% set lastIncludesVat = null %}
        {% set vatWarning = false %}
        <div class="row mt-4">
            <div class="col">
                <h5>{{ 'invoice.appartment'|trans }}</h5>
                {% include 'Invoices/invoice_table_apartment_preview_positions.html.twig' with {'mode': 'read'} %}
            </div>
        </div>
            
        <div class="row mt-4">
            <div class="col">
                <h5>{{ 'invoice.miscellaneous'|trans }}</h5>
                {% include 'Invoices/invoice_table_misc_preview_positions.html.twig' with {'mode': 'read'} %}
            </div>
        </div>
        <div class="row mt-3">
            <small><span class="text-info me-auto"><i class="fas fa-info-circle"></i> {{ 'reservation.prices.preliminary'|trans }}</span></small>
        </div>
    </div>
</div>
